apiVersion: serving.knative.dev/v1
kind: Service
metadata:
  name: workforce-simulator
  labels:
    cloud.googleapis.com/location: us-central1
  annotations:
    run.googleapis.com/ingress: all
    run.googleapis.com/ingress-status: all
spec:
  template:
    metadata:
      annotations:
        # Scaling configuration
        autoscaling.knative.dev/minScale: "1"
        autoscaling.knative.dev/maxScale: "10"
        # CPU always allocated (not just during requests)
        run.googleapis.com/cpu-throttling: "false"
        # Startup CPU boost
        run.googleapis.com/startup-cpu-boost: "true"
        # VPC connector for database access (if using Cloud SQL)
        # run.googleapis.com/vpc-access-connector: projects/PROJECT_ID/locations/REGION/connectors/CONNECTOR_NAME
        # run.googleapis.com/vpc-access-egress: private-ranges-only
    spec:
      containerConcurrency: 80
      timeoutSeconds: 300
      serviceAccountName: workforce-simulator-sa@PROJECT_ID.iam.gserviceaccount.com
      containers:
        - name: workforce-simulator
          image: gcr.io/PROJECT_ID/workforce-simulator:latest
          ports:
            - name: http1
              containerPort: 8000
          env:
            - name: ENVIRONMENT
              value: production
            - name: LOG_LEVEL
              value: INFO
            - name: WORKERS
              value: "4"
            - name: CORS_ORIGINS
              value: "https://your-frontend-domain.com"
            # Database URL from Secret Manager
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  name: database-url
                  key: latest
            # Redis URL from Secret Manager
            - name: REDIS_URL
              valueFrom:
                secretKeyRef:
                  name: redis-url
                  key: latest
            # Groq API Key from Secret Manager
            - name: GROQ_API_KEY
              valueFrom:
                secretKeyRef:
                  name: groq-api-key
                  key: latest
          resources:
            limits:
              cpu: "2"
              memory: 2Gi
            requests:
              cpu: "1"
              memory: 1Gi
          startupProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 12
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 0
            periodSeconds: 30
            timeoutSeconds: 5
            failureThreshold: 3
  traffic:
    - percent: 100
      latestRevision: true
